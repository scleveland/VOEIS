:css
  #content { margin:10px 50px }
  #wrapper {
    padding-bottom: 20px;
    background-color: #ccb;
    padding-top: 1px;
  }
  #wrapper img { margin-right:12px }
  #wrapper p { margin:0 20px }

  #form-table { width:600px; }
  #form-table td { width:50%; }
  .form_element { width:20em; }
  
  .dijitTextBox { width:18em !important; }
  .TextBox_name { width:25em !important; }
  
  .new_voeis_site input { width:18em; }
  .new_voeis_site textarea { width:45em; }
  .new_voeis_site select { width:21em; }


- content_for(:javascripts) do
  :javascript
    dojo.require("dijit.dijit");
    dojo.require("dijit.Declaration");
    dojo.require("dijit.layout.ContentPane");
    dojo.require("dijit.layout.TabContainer");
    dojo.require("dojox.layout.TableContainer");
    dojo.require("dojox.layout.ContentPane");
    dojo.require("dijit.Dialog");
    dojo.require("dijit.form.Form");
    dojo.require("dijit.form.TextBox");
    dojo.require("dijit.form.Button");
    dojo.require("dijit.form.ValidationTextBox");
    dojo.require("dijit.Tooltip");
    


-# $.post("#{root_url}/vertical_datum.json?vertical_datum[term]="+$("#vertical_datum_term").val()+"&vertical_datum_definition[definition]="+$("#vertical_datum_definition").val(),

-# RENDER CREATE-NEW DIALOGS
-#= render(:partial => "../views/voeis/sites/new_vertical_datum")
-#= render(:partial => "../views/voeis/sites/new_local_projection")


%h2{:id=>"site00-name-head", :style=>"margin-top:0;"}
  $$$site-name$$$

-#-if !current_user.nil? && current_user.projects.include?(@project)
-#  = link_to('Edit', edit_project_site_path(@project,@site.id), :class=>'icon icon-edit')
-#  &nbsp;&nbsp;&nbsp;
-#= link_to('Cancel', project_path(@project), :class => 'icon icon-cancel') 
-#%br
-#%br

#show-site00{:style=>"margin-top:0;padding-top:0;"}
  %table
    %tr
      %td{:style=>"width:200px;"}
        %b SHOW DETAILS
      %td
        -#= link_to('CANCEL', project_path(@project), :class => 'icon icon-cancel') 
        -#= link_to('CANCEL', '#', :class=>'icon icon-cancel', :onclick=>'window.history.back();return false;') 
        -#-if !@current_user.nil? && @current_user.projects.include?(@project)
        -if @auth
          &nbsp;&nbsp;&nbsp;
          -#= link_to('EDIT', 'javascript:', :class=>'icon icon-edit', :onclick=>"init_site_form($$$id$$$);$('#show-site00').hide();$('#edit-site00').show();")
          = link_to('EDIT', 'javascript:', :class=>'icon icon-edit', :onclick=>"$('#show-site00').hide();$('#edit-site00').show();")
          -#%br
          -#&nbsp;&nbsp;&nbsp;
          -#= link_to('TEST', 'javascript:', :class=>'icon icon-edit', :onclick=>"alert('EDIT>>> '+site_pane2.editMode);") 
  %br

  %table{:id=>"site00-property-table", :style=>"width:46%;margin-right:20px;float:left;"}
    - @site_properties.each do |prop|
      %tr{:class=>"row#{cycle('1','0')}"}
        %td
          %b
            #{prop[:label]}
        %td{:class=>"show_#{prop[:name]}"}
          $$$#{prop[:name]}$$$

  -#%br{:style=>'float:none; clear:both;'}
  -#%br

  %table{:id=>"site00-variable-table", :style=>"width:48%;foat:left;"}
    %tr
      %th{:width=>"40%"} Variable Data
      %th{:width=>"20%", :align=>"left"} Count
      %th{:width=>"15%", :align=>"left"} Start
      %th{:width=>"15%", :align=>"left"} Stop
    %tr
      %td
        $$$site-variable-data$$$

  -#%br{:style=>'float:none; clear:both;'}
  %div
    %h3{:style=>"margin-top:0;"}
      Existing Samples
    #all_variables-site00{:style=>"$$$export-style$$$"}
      = form_for("export", :url=> {:controller=>'/projects', :action=>'export'}) do 
        = hidden_field_tag('column_array', @sample_labels.to_json)
        = hidden_field_tag('row_array', "$$$site-samps$$$")
        = hidden_field_tag('file_name', "project_samples")
        = submit_tag("Export Samples")

        %br
        %br    
    %table{:id=>"site00-sample-table", :style=>"width:45%;"} 
      %tr
        - @sample_labels.each do |label|
          %th{:style=>"width:23%;align:center;"}
            %b
              = label
      %tr
        %td{:colspan=>"4"}
          %div{:class=>"sample-list"}  
            %table
              %tr
                %td{:style=>"width:23%;align:center;"}
                  $$$site-sample-data$$$

  -##testing-site00{:dojoType=>"dijit.form.Button"}
  -#  TESTING
  -#  %script{:type=>"dojo/method", :event=>"onClick", :args=>"evt"}
  -#    //var form = dijit.byId("site00_local_projection_form");
  -#    console.log('TEST BUTTON: CLICK!!');
  -#    alert('TEST BUTTON: CLICK!!');
    

-if @auth
  -##edit-site00{:dojoType=>"dijit.layout.ContentPane", :title=>'EDIT', :style=>"margin-top:0;padding-top:0;display:none;"}
  #edit-site00{:style=>"margin-top:0;padding-top:0;display:none;"}

    -#site00_xnew_local_projection{:dojoType=>"dijit.Dialog", :title=>"NEW Local Projection"}
    -##site00_new_local_projection{:dojoType=>"dijit.Dialog", :jsId=>"site00_new_local_projection", :title=>"NEW Local Projection"}
    -#  TESTING Local Projection
    -##site00_new_vertical_datum{:dojoType=>"dijit.Dialog", :jsId=>"site00_new_local_projection", :title=>"NEW Local Projection"}
    -#  TESTING Vertical Datum

    #site00_new_vertical_datum{:dojoType=>"dijit.Dialog", :jsId=>"site00_new_vertical_datum", :title=>"NEW Vertical Datum", :style=>"width:400px;"}
      %form(id="site00_vertical_datum_form" jsId="site00_vertical_datum_form" dojoType="dijit.form.Form" method="post")
        %label Term
        %br
        %input(name="vertical_datum_term" dojoType="dijit.form.ValidationTextBox" id="site00_vertical_datum_term" size="30" required="true")
        %br{:style=>'float:none; clear:both;'}
        %br
        %label Definition
        %br
        %textarea{:type=>"text", :name=>"vertical_datum_definition", :id=>"site00_vertical_datum_definition", :style=>"width:95%;", :rows=>"4"}
        %br{:style=>'float:none; clear:both;'}
        %br
        %button{:id=>"site00_vertical_datum_submit_button",:dojoType=>"dijit.form.Button", :title=>'Create'}
          Create Vertical Datum
          %script{:type=>"dojo/method", :event=>"startup"}
            var form = dijit.byId("site00_vertical_datum_form");
            //var form = dijit.byId("site00_vertical_datum_form");
            // set initial state
            this.attr("disabled", !form.isValid());
            this.connect(form, "onValidStateChange", function(state){
            this.attr("disabled", !state);
            });
            this.connect(form, "onClick", function(){
            var data = {vertical_datum_c_v: {
            term: $("#site00_vertical_datum_term").val(),
            definition: $("#site00_vertical_datum_definition").val()}};
            console.log('POST:',data);
            $.post("/vertical_datum_c_vs.json", data, function(dat) {
            $('#site00_vertical_datum').append($("<option></option>").attr("value",dat['id']).text($('#site00_vertical_datum_term').val()));
            $('#site00_vertical_datum').val(dat['id']);
            site00_new_vertical_datum.hide();
            });
            });
            
        &nbsp;&nbsp;
        %button{:dojoType=>"dijit.form.Button", :title=>'Cancel', :onClick=>"site00_new_vertical_datum.hide();return false;"} Cancel
    
    -#site00_xnew_local_projection{:title=>"NEW Local Projection", :style=>"display:none;"}
    #site00_new_spatial_reference{:dojoType=>"dijit.Dialog", :jsId=>"site00_new_spatial_reference", :title=>"NEW Spatial Reference", :style=>"width:400px;"}
      %form(id="site00_spatial_reference_form" jsId="site00_spatial_reference_form" dojoType="dijit.form.Form" method="post")
        %label Source ID
        %br
        -#=f.text_field :quality_control_level_code, :size => 30
        -#%input{:type=>"text", :name=>"local_projection_term", :id=>"site00_local_projection_term", :dojoType=>"dijit.form.ValidationTextBox", :size=>40,  :style=>"width:30em", :required=>"true"}
        -#%input{:type=>"text", :name=>"local_projection_term", :id=>"site00_local_projection_term", :style=>"width:95%;"}
        %input(name="source_id" dojoType="dijit.form.NumberTextBox" id="site00_source_id" size="30" required="true")
        &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
        &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
        %input(name="source_geographic" dojoType="dijit.form.CheckBox" id="site00_source_geographic")
        Geographic
        %br{:style=>'float:none; clear:both;'}
        %br
        %label Source Name
        %br
        -#=f.text_field :quality_control_level_code, :size => 30
        -#%input{:type=>"text", :name=>"local_projection_term", :id=>"site00_local_projection_term", :dojoType=>"dijit.form.ValidationTextBox", :size=>40,  :style=>"width:30em", :required=>"true"}
        -#%input{:type=>"text", :name=>"local_projection_term", :id=>"site00_local_projection_term", :style=>"width:95%;"}
        %input(name="source_name" dojoType="dijit.form.ValidationTextBox" id="site00_source_name" size="50" required="true")
        
        %br{:style=>'float:none; clear:both;'}
        %br
        %label Notes
        %br
        -#=f.text_area :definition, :cols=>50, :rows=>3
        -#%input{:type=>"text", :name=>"local_projection_definition", :id=>"site00_local_projection_definition", :dojoType=>"dijit.form.ValidationTextBox", :style=>"width:50em", :size=>50, :rows=>"3"}
        %textarea{:type=>"text", :name=>"source_notes", :id=>"site00_source_notes", :style=>"width:95%;", :rows=>"4"}
        %br{:style=>'float:none; clear:both;'}
        %br
        -#%button{:id=> 'site00_new_local_projection_buttonx',:dojoType=>"dijit.form.Button", :title=>'Create', :onClick=>"site00_createLocalProjection();"}
        -#%button{:id=>'site00_new_local_projection_buttonx',:dojoType=>"dijit.form.Button", :title=>'Create'}
        -#%button{:id=>'site00_new_local_projection_button', :value=>"Create Local Projection", :onclick=>"submit_site_dialog($$$id$$$,'local_projection');site00ref.dialog.hide();return false;"}
        %button{:id=>"site00_source_submit_button",:dojoType=>"dijit.form.Button", :title=>'Create'}
          Create Spatial Reference
          %script{:type=>"dojo/method", :event=>"startup"}
            var form = dijit.byId("site00_spatial_reference_form");
            // set initial state
            this.attr("disabled", !form.isValid());
            this.connect(form, "onValidStateChange", function(state){
            this.attr("disabled", !state);
            });
            this.connect(form, "onClick", function(){
            var is_geo = (dojo.byId("site00_source_geographic").checked) ? true : false;
            var data = {spatial_reference: {
            srs_id: parseInt($("#site00_source_id").val()),
            srs_name: $("#site00_source_name").val(),
            is_geographic: is_geo,
            notes: $("#site00_source_notes").val()}};
            console.log('POST:',data);
            $.post("/spatial_references.json", data, function(dat) {
            $('#site00_lat_long_datum').append($("<option></option>").attr("value",dat['id']).text($('#site00_source_name').val()));
            if(SRfrom=='LLD') $('#site00_lat_long_datum').val(dat['id']);
            $('#site00_local_projection').append($("<option></option>").attr("value",dat['id']).text($('#site00_source_name').val()));
            if(SRfrom='LP') $('#site00_local_projection').val(dat['id']);
            site00_new_spatial_reference.hide();
            });
            });
        &nbsp;&nbsp;
        -#%button{:onclick=>"site00ref.dialog.hide();return false;", :value=>"Cancel"} Cancel
        %button{:dojoType=>"dijit.form.Button", :title=>'Cancel', :onClick=>"site00_new_spatial_reference.hide();return false;"} Cancel
    
    
    -##site00_xnew_local_projection{:title=>"NEW Local Projection", :style=>"display:none;"}
    -#  -#= form_for :local_projection, :url=>"", :html=>{:dojoType=>"dijit.form.Form", :id=>"site00_local_projection_form"} do |f|
    -#  -#%form(id="site00_local_projection_form" jsId="site00_local_projection_form" dojoType="dijit.form.Form" method="post")
    -#  %form(id="site00_local_projection_form" method="post")
    -#    %label Term
    -#    %br
    -#    -#=f.text_field :quality_control_level_code, :size => 30
    -#    -#%input{:type=>"text", :name=>"local_projection_term", :id=>"site00_local_projection_term", :dojoType=>"dijit.form.ValidationTextBox", :size=>40,  :style=>"width:30em", :required=>"true"}
    -#    %input{:type=>"text", :name=>"local_projection_term", :id=>"site00_local_projection_term", :style=>"width:95%;"}
    -#    %br{:style=>'float:none; clear:both;'}
    -#    %br
    -#    %label Definition
    -#    %br
    -#    -#=f.text_area :definition, :cols=>50, :rows=>3
    -#    -#%input{:type=>"text", :name=>"local_projection_definition", :id=>"site00_local_projection_definition", :dojoType=>"dijit.form.ValidationTextBox", :style=>"width:50em", :size=>50, :rows=>"3"}
    -#    %textarea{:type=>"text", :name=>"local_projection_definition", :id=>"site00_local_projection_definition", :style=>"width:95%;", :rows=>"4"}
    -#    %br{:style=>'float:none; clear:both;'}
    -#    %br
    -#    -#%button{:id=> 'site00_new_local_projection_buttonx',:dojoType=>"dijit.form.Button", :title=>'Create', :onClick=>"site00_createLocalProjection();"}
    -#    -#%button{:id=>'site00_new_local_projection_buttonx',:dojoType=>"dijit.form.Button", :title=>'Create'}
    -#    %button{:id=>'site00_new_local_projection_button', :value=>"Create Local Projection", :onclick=>"submit_site_dialog($$$id$$$,'local_projection');site00ref.dialog.hide();return false;"}
    -#      Create Local Projection
    -#      -#%script{:type=>"dojo/method", :event=>"startup"}
    -#      -#  var form = dijit.byId("site00_local_projection_form");
    -#      -#  // set initial state
    -#      -#  //this.attr("disabled", !form.isValid());
    -#      -#  //this.connect(form, "onValidStateChange", function(state){
    -#      -#  //this.attr("disabled", !state);
    -#      -#  //});
    -#      -#  this.connect(form, "onClick", function(){
    -#      -#  //$.post("#{root_url}/local_projection_cvs.json?local_projection_c_vs[term]="+$("#site00_local_projection_term").val()+"&local_projection_c_vs[definition]="+$("#site00_local_projection_definition").val(),
    -#      -#  $.post("#{@root_url}/local_projection_c_vs.json", {local_projection_c_v: {term: $("#site00_local_projection_term").val(), definition: $("#site00_local_projection_definition").val()}},
    -#      -#  function(data) {
    -#      -#  //$('#site00_local_projection').append($("<option></option>").attr("value",data['id']).text($("#site00_vertical_datum_term").val() + ':' + $("#site00_vertical_datum_definition").val())); 
    -#      -#  $('#site00_local_projection').append($("<option></option>").attr("value",data['id']).text($("#site00_vertical_datum_term").val()));
    -#      -#  $('#site00_local_projection').val(data['id']);
    -#      -#  dijit.byId("site00_xnew_local_projection").hide();
    -#      -#  });
    -#      -#  };
    -#    &nbsp;&nbsp;
    -#    -#%button{:dojoType=>"dijit.form.Button", :title=>'Cancel', :onClick=>"dijit.byNode(dojo.byId('site00')).dialog.hide();"} Cancel
    -#    %button{:onclick=>"site00ref.dialog.hide();return false;", :value=>"Cancel"} Cancel
    -#
    -##site00_xnew_vertical_datum{:title=>"NEW Vertical Datum", :style=>"display:none;"}
    -#  -#= form_for :vertical_datum_c_vs, :url=>"", :html=>{:dojoType=>"dijit.form.Form", :id=>"site00_vertical_datum_form"} do |f|
    -#  -#%form(id="site00_vertical_datum_form" jsId="site00_vertical_datum_form" dojoType="dijit.form.Form" method="post")
    -#  %form(id="site00_vertical_datum_formXX" method="post")
    -#    %label Term
    -#    %br
    -#    -#=f.text_field :quality_control_level_code, :size => 30
    -#    -#%input{:type=>"text", :name=>"vertical_datum_term", :id=>"site00_vertical_datum_term", :dojoType=>"dijit.form.ValidationTextBox", :size=>40,  :style=>"width:30em", :required=>"true"}
    -#    %input{:type=>"text", :name=>"vertical_datum_term", :id=>"site00_vertical_datum_termXX", :style=>"width:95%;"}
    -#    %br{:style=>'float:none; clear:both;'}
    -#    %br
    -#    %label Definition
    -#    %br
    -#    -#=f.text_area :definition, :cols=>50, :rows=>3
    -#    -#%input{:type=>"text", :name=>"vertical_datum_definition", :id=>"site00_vertical_datum_definition", :dojoType=>"dijit.form.ValidationTextBox", :style=>"width:50em", :size=>50, :rows=>"3", :required=>"true"}
    -#    %textarea{:type=>"text", :name=>"vertical_datum_definition", :id=>"site00_vertical_datum_definitionXX", :style=>"width:95%;", :rows=>"4"}
    -#    %br{:style=>'float:none; clear:both;'}
    -#    %br
    -#    -#%button{:id=> 'site00_new_vertical_datum_button',:dojoType=>"dijit.form.Button", :title=>'Create', :onClick=>"site00_createVerticalDatum();return false;"}
    -#    -#%button{:id=> 'site00_new_vertical_datum_button',:dojoType=>"dijit.form.Button", :title=>'Create'}
    -#    %button{:id=> 'site00_new_vertical_datum_buttonXX', :value=>"Create Vertical Datum", :onClick=>"submit_site_dialog($$$id$$$,'vertical_datum');site00ref.dialog.hide();return false;"}
    -#      Create Vertical Datum
    -#      -#%script{:type=>"dojo/method", :event=>"startup"}
    -#      -#  var form = dijit.byNode(dojo.byId("site00_vertical_datum_form"));
    -#      -#  // set initial state
    -#      -#  this.attr("disabled", !form.isValid());
    -#      -#  this.connect(form, "onValidStateChange", function(state){
    -#      -#  this.attr("disabled", !state);
    -#      -#  });
    -#      -#  this.connect(form, "onClick", function(){
    -#      -#  console.log('create Vert Datum CV');
    -#      -#  $.post("#{@root_url}/vertical_datum_c_vs.json", {vertical_datum_c_v: {term: $("#site00_vertical_datum_term").val(), definition: $("#site00_vertical_datum_definition").val()}},
    -#      -#  function(data) {
    -#      -#  //$('#site00_vertical_datum').append($("<option></option>").attr("value",data['id']).text($("#site00_vertical_datum_term").val() + ':' + $("#site00_vertical_datum_definition").val()));
    -#      -#  $('#site00_vertical_datum').append($("<option></option>").attr("value",data['id']).text($("#vertical_datum_term").val()));
    -#      -#  $('#site00_vertical_datum').val(data['id']);
    -#      -#  dijit.byId("site00_xnew_vertical_datum").hide();
    -#      -#  });
    -#      -#  };
    -#    &nbsp;&nbsp;
    -#    -#%button{:dojoType=>"dijit.form.Button", :title=>'Cancel', :onClick=>"dijit.byNode(dojo.byId('site00')).dialog.hide();"} Cancel
    -#    %button{:onClick=>"site00ref.dialog.hide();return false;", :value=>"Cancel"} Cancel

    %table{:id=>"site00-edit-control"}
      %tr
        %td{:style=>"width:200px;"}
          %b EDITING
        %td
          = link_to('CANCEL EDIT', 'javascript:', :class=>'icon icon-cancel', :onclick=>"$('#edit-site00').hide();$('#show-site00').show();") 
    %br


    -#%script{:type=>"dojo/method"}
    %script{:type=>"text/javascript"}
      console.log('DOJO/METHOD');
      
      function initForm2(siteTag) {
      console.log('onLoad FIRED!');
      //var form = dijit.byNode(dojo.byId(siteTag+'-edit-form'));
      var form = dijit.byId(siteTag+'-edit-form');
      //var pane = dijit.byNode(dojo.byId('site00'));
      //var submit_button = dijit.byNode(dojo.byId(siteTag+'_voeis_site_submit'));
      var submit_button = dijit.byId(siteTag+'_voeis_site_submit');
      //var submit_button = "TEST";
      console.log('form ('+siteTag+'-edit-form'+') = ',form);
      console.log('submit_button ('+siteTag+'_voeis_site_submit'+') = ',submit_button);
      submit_button.connect(form, "onClick", function(evt){
      console.log('SAVE FORM');
      //pane.siteFormSave(form);
      //$.post('#{@root_url}/projects/b6db01d0-e606-11df-863f-6e9ffb75bc80/sites/$$$id$$$',{site:{id:$$$id$$$, name:form.elements['site_name'].value, code:form.elements['site_code'].value, latitude:form.elements['site_latitude'].value, longitude:form.elements['site_longitude'].value, lat_long_datum_id:form.elements['site_lat_long_datum_id'].value, elevation_m:form.elements['site_elevation_m'].value, vertical_datum_id:form.elements['site_vertical_datum_id'].value, local_x:form.elements['site_local_x'].value, local_y:form.elements['site_local_y'].value, local_projection_id:form.elements['site_local_projection_id'].value, pos_accuracy_m:form.elements['site_pos_accuracy_m'].value, state:form.elements['site_state'].value, county:form.elements['site_county'].value, comments:form.elements['site_comments'].value, description:form.elements['site_description'].value}});
      return false;
      });
      console.log('onLoad DONE!');
      };
      
      function drop_down(form,fn,value) {
      var fld = form.elements[fn];
      if(!fld) return null;
      if(value)
      for(var i=0;i<fld.options.length;i++) 
      if(fld.options[i].value==value)
      fld.options[i].selected=true;
      if(fld.selectedIndex==-1 || fld.options.length==0) 
      return {value:null, text:'-none-', element:fld};
      opt = fld.options[fld.selectedIndex];
      return {value:parseInt(opt.value), text:opt.text, element:fld};
      }
      function validate_site_form() {
      return true;
      }
      
      function submit_site_form(siteId) {
      if(validate_site_form(siteId)) {
      console.log('CREATE SITE: '+siteId);
      var pane = dijit.byNode(dojo.byId('site'+siteId));
      var form0 = 'site'+siteId+'-edit-form';
      console.log('FORM ID:',form0);
      //var form = dijit.byNode(dojo.byId(form0));
      var form = dojo.byId(form0);
      //pane.siteFormSave(form);
      //dojo.publish('voeis/project/siteTables/refresh');
      
      console.log(pane,form);

      var lat_long_datum_dd = drop_down(form,'site_lat_long_datum');
      var vertical_datum_dd = drop_down(form,'site_vertical_datum');
      var local_projection_dd = drop_down(form,'site_local_projection');
      //console.log(vertical_datum_dd, local_projection_dd);
      //vertical_datum_id:form.elements['site_vertical_datum'].options[form.elements['site_vertical_datum'].selectedIndex], 
      //local_projection_id:form.elements['site_local_projection'].value
      var data = {site:{
      name:form.elements['site_name'].value, 
      code:form.elements['site_code'].value, 
      latitude:form.elements['site_latitude'].value, 
      longitude:form.elements['site_longitude'].value, 
      elevation_m:form.elements['site_elevation_m'].value, 
      local_x:form.elements['site_local_x'].value, 
      local_y:form.elements['site_local_y'].value, 
      pos_accuracy_m:form.elements['site_pos_accuracy_m'].value, 
      state:form.elements['site_state'].value, 
      county:form.elements['site_county'].value, 
      comments:form.elements['site_comments'].value, 
      description:form.elements['site_description'].value,
      lat_long_datum_id:lat_long_datum_dd.value, 
      vertical_datum_id:vertical_datum_dd.value,
      local_projection_id:local_projection_dd.value
      }};
      if(pane.newSite) {
      $.post('/projects/#{@project.id}/sites.json', data, function(newValue) {
      //
      console.log('NEW ID: '+newValue);
      data['site']['id'] = newValue.id;
      data['site']['vertical_datum'] = vertical_datum_dd.text;
      data['site']['local_projection'] = local_projection_dd.text;
      pane.siteSave(data['site']);
      //dojo.publish('voeis/project/siteTables/refresh');
      dojo.publish('voeis/project/site/close',[0]);
      dojo.publish('voeis/project/map/new',[newValue.id]);
      //var tabs = dijit.byId('tab_browser');
      //tabs.removeChild(pane);
      //pane.onClose();
      //pane.destroyRecursive();  
      });
      } else {
      data['site']['id'] = siteId;
      //save//$.post('#{@root_url}/projects/b6db01d0-e606-11df-863f-6e9ffb75bc80/sites/'+siteId,{site:{id:''+siteId, name:form.elements['site_name'].value, code:form.elements['site_code'].value, latitude:form.elements['site_latitude'].value, longitude:form.elements['site_longitude'].value, lat_long_datum_id:form.elements['site_lat_long_datum_id'].value, elevation_m:form.elements['site_elevation_m'].value, vertical_datum_id:form.elements['site_vertical_datum_id'].value, local_x:form.elements['site_local_x'].value, local_y:form.elements['site_local_y'].value, local_projection_id:form.elements['site_local_projection_id'].value, pos_accuracy_m:form.elements['site_pos_accuracy_m'].value, state:form.elements['site_state'].value, county:form.elements['site_county'].value, comments:form.elements['site_comments'].value, description:form.elements['site_description'].value}});
      //$.post('#{@root_url}/projects/#{@project.id}/sites/'+siteId, data);
      //$.post('/projects/#{@project.id}/sites/'+siteId+'.json', data);
      $.ajax({
      type: 'PUT',
      url: '/projects/#{@project.id}/sites/'+siteId,
      data: data,
      success: '',
      dataType: 'json'
      });
      data['site']['vertical_datum'] = vertical_datum_dd.text;
      data['site']['local_projection'] = local_projection_dd.text;
      pane.siteSave(data['site']);
      //dojo.publish('voeis/project/siteTables/refresh');
      dojo.publish('voeis/project/map/clear',[siteId]);
      };
      return false;
      };
      };
      
      function cancel_site_form(siteId) {
      if(parseInt(siteId)) {
      $('#edit-site'+siteId).hide();
      $('#show-site'+siteId).show();
      return
      }
      dojo.publish('voeis/project/site/close',[0]);
      };

      function submit_site_dialog(siteId,fn) {
      var siteTag = 'site'+siteId
      var pane = dijit.byNode(dojo.byId(siteTag));
      var form0 = siteTag+'-edit-form';
      var form = dojo.byId(form0);
      console.log('create = ',fn);
      data = {};
      data[fn+'_c_v'] = {term: $("#site"+siteId+"_"+fn+"_term").val(), definition: $("#site"+siteId+"_"+fn+"_definition").val()};
      $.post("/"+fn+"_c_vs.json", data, function(dat) {
      //$.post("#{@root_url}/"+fn+"_c_vs.json", data, function(dat) {
      //save//$('#site00_vertical_datum').append($("<option></option>").attr("value",data['id']).text($("#site00_vertical_datum_term").val() + ':' + $("#site00_vertical_datum_definition").val()));
      $('#site'+siteId+'_'+fn).append($("<option></option>").attr("value",dat['id']).text($('#site'+siteId+'_'+fn+'_term').val()));
      $('#site'+siteId+'_'+fn).val(dat['id']);
      });
      //test//$('#site'+siteId+'_'+fn).append($("<option></option>").attr("value",'10').text($('#site'+siteId+'_'+fn+'_term').val()));
      //test//$('#site'+siteId+'_'+fn).val('10');
      };
      
      function valid_site_change(siteId,btn) {
      var form = dijit.byId('site'+siteId+'-edit-form');
      // set initial state
      btn.attr("disabled", !form.isValid());
      btn.connect(form, "onValidStateChange", function(state){
      btn.attr("disabled", !state);
      });
      };
      
      function init_site_form(siteId) { setTimeout(function() {
      var SRfrom = '';
      var siteTag = 'site'+siteId;
      var form0 = siteTag+'-edit-form';
      var form = dijit.byId(form0);
      console.log('INIT-FORM:',form0,form);
      form0 = form.domNode;
      var pane = dijit.byNode(dojo.byId(siteTag));
      var site = pane.site;
      //console.log('INIT:',form0);
      var lat_long_datum_dd = drop_down(form0,'site_lat_long_datum',site.lat_long_datum_id).element;
      var local_projection_dd = drop_down(form0,'site_local_projection',site.local_projection_id).element;
      var vertical_datum_dd = drop_down(form0,'site_vertical_datum',site.vertical_datum_id).element;
      console.log('VerticalDatum ID:',site.vertical_datum_id);
      console.log('LocalProjection ID:',site.local_projection_id);
      //var submit_button = dijit.byId('site00_voeis_site_submit');
      //var submit_button = dijit.byNode(form0.elements['commit']);
      var submit_button = dijit.byId('site'+siteId+'_voeis_site_submit');
      // set initial state: submit button
      if(!pane.newSite) submit_button.attr("disabled", !form.validate());
      //submit_button.attr("disabled", !this.isValid());
      form0.elements['site_name'].focus();

      //IS FORM VALID?
      console.log('FORM-CONNECT:',siteId,form);
      form.connect(form, "onValidStateChange", function(state){
      console.log('formStateChange:',state);
      submit_button.attr("disabled", !state);
      });
      }, 200)};
      
      

    -#= form_for(:site, @site, :remote=>true, :url=>project_site_path(@project, @site), :builder=>YogoFormBuilder, :html=>{:method=>"put", :onsubmit=>"return checkform();"} )do |f|
    -#= form_for(:site, @site, :remote=>true, :url=>"/projects/#{@project.id}/sites/$$$id$$$/", :html=>{:method=>:put, :id=>"site00-edit-form", :onsubmit=>"dijit.byNode(dojo.byId('site00')).siteFormSave(this);return true;"} )do |f|
    -#= form_for(@site0, :remote=>true, :url=>"/projects/#{@project.id}/sites/$$$id$$$/", :html=>{:method=>:put, :id=>"site00-edit-form"} )do |f|
    -# = form_for(@site, :as=>:site, :remote=>true, :url=>"/projects/#{@project.id}/sites/$$$id$$$/", :html=>{:method=>:put, :id=>"site00-edit-form"} )do |f|
    -#%form(accept-charset="UTF-8" action="/projects/b6db01d0-e606-11df-863f-6e9ffb75bc80/sites/$$$id$$$" class="new_voeis_site" data-remote="true" id="site00-edit-form" dojoType="dijit.form.Form" method="put")
    -#%form(accept-charset="UTF-8" action="/projects/b6db01d0-e606-11df-863f-6e9ffb75bc80/sites/$$$id$$$" class="new_voeis_site" data-remote="true" id="site00-edit-form" jsId="site00_edit_form" dojoType="dijit.form.Form" method="put")
    -#%form(accept-charset="UTF-8" action="/projects/b6db01d0-e606-11df-863f-6e9ffb75bc80/sites/$$$id$$$" class="new_voeis_site" data-remote="true" id="site00-edit-form" method="put")
    
    -#%form(accept-charset="UTF-8" action="/projects/b6db01d0-e606-11df-863f-6e9ffb75bc80/sites/$$$id$$$" class="new_voeis_site" data-remote="true" id="site00-edit-form" method="put")
    %form(accept-charset="UTF-8" class="new_voeis_site" data-remote="true" id="site00-edit-form" jsId="site00_edit_form" dojoType="dijit.form.Form")
      %script{:type=>"dojo/method", :event=>"onKeyPress", :args=>"key"}
        console.log('KEYPRESS:',key);
        //var submit_button = dijit.byId('site00_voeis_site_submit');
        // set changed state
        //submit_button.attr("disabled", !state);
      -#--%script{:type=>"dojo/method", :event=>"onValidStateChange", :args=>"state"}
      -#--var submit_button = dijit.byId('site00_voeis_site_submit');
      -#--// set changed state
      -#--console.log('formStateChange:',state);
      -#--submit_button.attr("disabled", !state);
      -#--%script{:type=>"dojo/method", :event=>"startup"}
      -#--var submit_button = dijit.byId('site00_voeis_site_submit');
      -#--// set initial state
      -#--//submit_button.attr("disabled", !this.validate());
      -#--//submit_button.attr("disabled", !this.isValid());
      -#--//this.connect(this, "onValidStateChange", function(state){
      -#--//submit_button.attr("disabled", !this.validate());
      -#--//this.domNode.elements['site_name'].focus()
      -#--//});
      -#%script{:type=>"dojo/method", :event=>"onValidStateChange", :args=>"state"}
      -#  var submit_button = dijit.byId('site00_voeis_site_submit');
      -#  // set changed state
      -#  submit_button.attr("disabled", !state);

      %table{:id=>"form-table"}
        %tr
          %td
            .from-element
              %span{:class=>'label'}
                %label{:for=>"site_name"} Name
              -#= f.text_field("name", :value=>"$$$name$$$")
              -#%input(name="site_name" dojoType="dijit.form.ValidationTextBox" size="50" type="text" value="$$$name$$$" required="true")
              -#%input(name="site_name" id="site00_name" type="text" value="$$$name$$$")
              %input(name="site_name" class="TextBox_name" dojoType="dijit.form.ValidationTextBox" id="site00_name" type="text" value="$$$name$$$" required="true")
          %td
            .from-element
              %span{:class=>'label'}
                %label{:for=>"site_code"} Code
              -#= f.text_field("code", :value=>"$$$code$$$")
              -#%input(name="site_code"  dojoType="dijit.form.ValidationTextBox"  size="30" type="text" value="$$$code$$$" required="true")
              -#%input(name="site_code"  type="text" value="$$$code$$$")
              %input(name="site_code" dojoType="dijit.form.ValidationTextBox" type="text" value="$$$code$$$" required="true")
        %tr
          %td
            .from-element
              %span{:class=>'label'}
                %label{:for=>"site_latitude"} Latitude
              -#= f.text_field("latitude", :value=>"$$$latitude$$$")
              -#%input(name="site_latitude"  dojoType="dijit.form.ValidationTextBox"  size="30" type="text" value="$$$latitude$$$" required="true")
              -#%input(name="site_latitude" id="site00_latitude" type="text" value="$$$latitude$$$")
              %input(name="site_latitude" dojoType="dijit.form.NumberTextBox" id="site00_latitude" type="text" value="$$$latitude$$$" required="true")
          %td
            .from-element
              %span{:class=>'label'}
                %label{:for=>"site_longitude"} Longitude
              -#= f.text_field("longitude", :value=>"$$$longitude$$$")
              -#%input(name="site_longitude"  dojoType="dijit.form.ValidationTextBox"  size="30" type="text" value="$$$longitude$$$" required="true")
              -#%input(name="site_longitude" id="site00_longitude" type="text" value="$$$longitude$$$")
              %input(name="site_longitude" dojoType="dijit.form.NumberTextBox" id="site00_longidude" type="text" value="$$$longitude$$$" required="true")

        %tr
          %td{:colspan=>"2"}
            .from-element
              %span{:class=>'label'}
                %label{:for=>"site_lat_long_datum", :style=>"cursor:pointer;", :class=>"icon icon-add", :onclick=>"SRfrom='LLD';site00_new_spatial_reference.show();"}
                  Latitude Longitude Datum
            -#= f.text_field("local_projection", :value=>"$$$local_projection$$$") 
            -#= f.select('local_projection',  options_for_select(@local_projection_items, '$$$local_projection$$$'), :class=>"form-dropdown")
            %select(id="site00_lat_long_datum" name="site_lat_long_datum")
              - @local_projection_items.each do |item|
                %option(value="#{item[1]}") #{item[0]}

        %tr
          %td{:colspan=>"2"}
            .from-element
              %span{:class=>'label'}
                %label{:for=>"site_elevation_m"} Elevation
              -#= f.text_field("elevation_m", :value=>"$$$elevation_m$$$")
              -#%input(name="site_elevation_m" type="text" value="$$$elevation_m$$$")
              %input(name="site_elevation_m" dojoType="dijit.form.NumberTextBox" type="text" value="$$$elevation_m$$$")
        %tr
          %td 
            .from-element
              %span{:class=>'label'}
                %label{:for=>"site_local_x"} Local X
              -#= f.text_field("local_x", :value=>"$$$local_x$$$")
              -#%input(name="site_local_x"  type="text" value="$$$local_x$$$")
              %input(name="site_local_x" dojoType="dijit.form.NumberTextBox" type="text" value="$$$local_x$$$")
          %td 
            .from-element
              %span{:class=>'label'}
                %label{:for=>"site_local_y"} Local Y
              -#= f.text_field("local_y", :value=>"$$$local_y$$$")
              -#%input(name="site_local_y"  type="text" value="$$$local_y$$$")
              %input(name="site_local_y" dojoType="dijit.form.NumberTextBox" type="text" value="$$$local_y$$$")

        %tr
          %td{:colspan=>"2"}
            .from-element
              %span{:class=>'label'}
                %label{:for=>"site_local_projection", :style=>"cursor:pointer;", :class=>"icon icon-add", :onclick=>"SRfrom='LP';site00_new_spatial_reference.show();"}
                  Local Projection
            -#= f.text_field("local_projection", :value=>"$$$local_projection$$$") 
            -#= f.select('local_projection',  options_for_select(@local_projection_items, '$$$local_projection$$$'), :class=>"form-dropdown")
            %select(id="site00_local_projection" name="site_local_projection")
              - @local_projection_items.each do |item|
                %option(value="#{item[1]}") #{item[0]}
            -#%td{:style=>"padding-top:20px;"}
            -#&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
            -#= link_to('NEW', 'javascript:', :onclick=>"dijit.byId('site00_new_local_projection').show();")
            -#= link_to('NEW', 'javascript:', :onclick=>"$('#edit-site00 .hide-row').hide();$('#site00_new_local_projection_row').show();")
            -#= link_to('NEW', 'javascript:', :onclick=>"dijit.byNode(dojo.byId('site00')).showDialog('site00_xnew_local_projection');")

        %tr
          %td{:colspan=>"2"}
            .from-element
              %span{:class=>'label'}
                -#%label{:for=>"site_vertical_datum", :style=>"cursor:pointer;", :class=>"icon icon-add", :onclick=>"dijit.byNode(dojo.byId('site00')).showDialog('site00_xnew_vertical_datum');"}
                %label{:for=>"site_vertical_datum", :style=>"cursor:pointer;", :class=>"icon icon-add", :onclick=>"site00_new_vertical_datum.show();"}
                  Vertical Datum
            -#= f.text_field("vertical_datum", :value=>"$$$vertical_datum_id$$$") 
            -#= f.select("site00_vertical_datum", options_for_select([]), :class=>"form-dropdown")
            -#= f.select('vertical_datum', options_for_select(@vertical_datum_items), :class=>"form-dropdown")
            %select(id="site00_vertical_datum" name="site_vertical_datum")
              - @vertical_datum_items.each do |item|
                %option(value="#{item[1]}") #{item[0]}
            -#%td{:style=>"padding-top:20px;"}
            -#&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
            -#= link_to('NEW', 'javascript:', :onclick=>"$('#edit-site00 .hide-row').hide();$('#site00_new_vertical_datum_row').show();")
            -#= link_to('NEW', 'javascript:', :onclick=>"dijit.byNode(dojo.byId('site00')).showDialog('site00_xnew_vertical_datum');")

        %tr
          %td{:colspan=>"2"}
            .from-element
              %span{:class=>'label'}
                %label{:for=>"site_pos_accuracy_m"} Position Accuracy
            -#= f.text_field("pos_accuracy_m", :value=>"$$$pos_accuracy_m$$$")
            -#%input(name="site_pos_accuracy_m" type="text" value="$$$pos_accuracy_m$$$")
            %input(name="site_pos_accuracy_m" dojoType="dijit.form.NumberTextBox" type="text" value="$$$pos_accuracy_m$$$")
        %tr
          %td 
            .from-element
              %span{:class=>'label'}
                %label{:for=>"site_state"} State
            -#= f.text_field("state", :value=>"$$$state$$$")
            -#%input(name="site_state" type="text" value="$$$state$$$")
            %input(name="site_state" dojoType="dijit.form.ValidationTextBox" type="text" value="$$$state$$$" required="true")
          %td 
            .from-element
              %span{:class=>'label'}
                %label{:for=>"site_county"} County
            -#= f.text_field("county", :value=>"$$$county$$$")
            -#%input(name="site_county" type="text" value="$$$county$$$")
            %input(name="site_county" dojoType="dijit.form.ValidationTextBox" type="text" value="$$$county$$$")
        %tr
          %td{:colspan=>"2"}
            .from-element
              %span{:class=>'label'}
                %label{:for=>"site_description"} Description
            -#= f.text_area("description", :value=>"$$$description$$$")
            -#%textarea( name="site_description" id="site00_description" rows="5")
            -#site00-description(name="site_description" dojoType="dijit.form.Textarea")
            %textarea( name="site_description" id="site00_description" rows="5")
              $$$description$$$
        %tr
          %td{:colspan=>"2"}
            .from-element
              %span{:class=>'label'}
                %label{:for=>"site_comments"} Comments
            -#= f.text_area("comments", :value=>"$$$comments$$$")
            -#%textarea( name="site_comments" id="site00_comments" rows="5")
            -#site00-comments(name="site_comments" dojoType="dijit.form.Textarea")
            %textarea( name="site_comments" id="site00_comments" rows="5")
              $$$comments$$$

        %tr
          %td{:colspan=>"2"}
            %br
            -#= f.submit("Save Site", :onclick => "$('#loader').toggle();")
            -#%button(id="site00_voeis_site_submit" name="commit" dojoType="dijit.form.Button" onclick="if(formValid()){$('#loader').toggle();formSend();};")
            -#%button(id="site00_voeis_site_submit" name="commit" dojoType="dijit.form.Button" onclick="console.log('CLICK!');")
            -#%button(id="site00_voeis_site_submit" jsId="site00_voeis_site_submit" name="commit" dojoType="dijit.form.Button") Save Site
            %button(dojoType="dijit.form.Button" id="site00_voeis_site_submit" name="commit" value="Save Site" onClick="submit_site_form($$$id$$$);return false;" disabled="true") 
              Save Site
              -#%script{:type=>"dojo/method", :event=>"startup"}
              -#  var form = dijit.byNode(dojo.byId('site00-edit-form'));
              -#  // set initial state
              -#  this.attr("disabled", !form.isValid());
              -#  this.connect(form, "onValidStateChange", function(state){
              -#  this.attr("disabled", !state);
              -#  });
            -#%script{:type=>"dojo/method", :event=>"onClick"}
            -#%script{:type=>"text/javascript"}
            -#%script{:type=>"dojo/method", :event=>"onClick"}
            -#%script{:type=>"dojo/connect", :event=>"onClick"}
            -#%script{:type=>"dojo/method"}
            -#%script{:type=>"dojo/method", :event=>"onClick", :args=>"evt"}
            -#  var form = dijit.byNode(dojo.byId('site00-edit-form'));
            -#  var pane = dijit.byNode(dojo.byId('site00'));
            -#  //console.log('STARTUP')
            -#  //this.connect(form, "onClick", function(evt){
            -#  console.log('SAVE FORM')
            -#  pane.siteFormSave(form);
            -#  $.post('#{@root_url}/projects/b6db01d0-e606-11df-863f-6e9ffb75bc80/sites/$$$id$$$',{site:{id:$$$id$$$, name:form.elements['site_name'].value, code:form.elements['site_code'].value, latitude:form.elements['site_latitude'].value, longitude:form.elements['site_longitude'].value, lat_long_datum_id:form.elements['site_lat_long_datum_id'].value, elevation_m:form.elements['site_elevation_m'].value, vertical_datum_id:form.elements['site_vertical_datum_id'].value, local_x:form.elements['site_local_x'].value, local_y:form.elements['site_local_y'].value, local_projection_id:form.elements['site_local_projection_id'].value, pos_accuracy_m:form.elements['site_pos_accuracy_m'].value, state:form.elements['site_state'].value, county:form.elements['site_county'].value, comments:form.elements['site_comments'].value, description:form.elements['site_description'].value}});
            -#  return false;
            -#  //};
            -#  //function formValid(){
            -#  //
            -#  //};
            &nbsp;&nbsp;
            -#%button(dojoType="dijit.form.Button" onclick="console.log('CANCEL!');$('#edit-site00').hide();$('#show-site00').show();") 
            -#%button(id="site00_voeis_cancel" dojoType="dijit.form.Button") Cancel
            %button(dojoType="dijit.form.Button" id="site00_voeis_cancel" value="Cancel" onclick="cancel_site_form($$$id$$$)") Cancel
            -#&nbsp;&nbsp;
            -#= link_to('Cancel', 'javascript:', :class=>'icon icon-cancel', :onclick=>"$('#edit-site00').hide();$('#show-site00').show();") 
            -#= link_to('TEST', 'javascript:', :class=>'icon icon-cancel', :onclick=>"dijit.byNode(dojo.byId('site00')).siteFormSave(this);") 
            -#%input{:type=>"button", :value=>"TEST", :onclick=>"dijit.byNode(dojo.byId('site00')).siteFormSave(this.form);"}
            -#= link_to('Cancel', '#', :class=>'icon icon-cancel', :onclick=>'window.history.back();return false;') 


%br{:style=>'float:none; clear:both;'}
